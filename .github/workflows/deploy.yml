# GitHub Actions è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Workers
# 
# å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
# 
# @author seven
# @since 2025-11-28

name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci
        
      # 4. ç”Ÿæˆ Prisma Client
      - name: Generate Prisma Client
        run: npm run db:generate
        
      # 5. ç±»å‹æ£€æŸ¥å’Œæ„å»º
      - name: Type check and build
        run: npm run build
        
      # 6. éƒ¨ç½²åˆ° Cloudflare Workers
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          # ç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨åŒæ­¥åˆ° Cloudflare Workers
          # æ•æ„Ÿä¿¡æ¯åº”åœ¨ Cloudflare Dashboard ä¸­é…ç½®ä¸º Secret
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ALIPAY_APP_ID: ${{ secrets.ALIPAY_APP_ID }}
          ALIPAY_PRIVATE_KEY: ${{ secrets.ALIPAY_PRIVATE_KEY }}
          ALIPAY_PUBLIC_KEY: ${{ secrets.ALIPAY_PUBLIC_KEY }}
          ALIPAY_NOTIFY_URL: ${{ secrets.ALIPAY_NOTIFY_URL }}
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          WECHAT_MCH_ID: ${{ secrets.WECHAT_MCH_ID }}
          WECHAT_API_KEY: ${{ secrets.WECHAT_API_KEY }}
          WECHAT_NOTIFY_URL: ${{ secrets.WECHAT_NOTIFY_URL }}
          USTD_API_KEY: ${{ secrets.USTD_API_KEY }}
          USTD_NOTIFY_URL: ${{ secrets.USTD_NOTIFY_URL }}
          OFFICIAL_CHANNEL_ID: ${{ secrets.OFFICIAL_CHANNEL_ID }}
          IMAGE_GENERATION_API_URL: ${{ secrets.IMAGE_GENERATION_API_URL }}
          IMAGE_GENERATION_API_KEY: ${{ secrets.IMAGE_GENERATION_API_KEY }}
          VIDEO_GENERATION_API_URL: ${{ secrets.VIDEO_GENERATION_API_URL }}
          VIDEO_GENERATION_API_KEY: ${{ secrets.VIDEO_GENERATION_API_KEY }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          
      # 7. è®¾ç½® Telegram Webhook
      - name: Set Telegram Webhook
        if: success()
        run: |
          WORKER_URL="${{ secrets.WEBHOOK_URL }}"
          BOT_TOKEN="${{ secrets.BOT_TOKEN }}"
          
          if [ -z "$WORKER_URL" ] || [ -z "$BOT_TOKEN" ]; then
            echo "âš ï¸  WEBHOOK_URL æˆ– BOT_TOKEN æœªè®¾ç½®ï¼Œè·³è¿‡ Webhook è®¾ç½®"
            exit 0
          fi
          
          echo "è®¾ç½® Telegram Webhook..."
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook" \
            -H "Content-Type: application/json" \
            -d "{\"url\": \"${WORKER_URL}/webhook\"}")
          
          echo "Telegram API å“åº”: $RESPONSE"
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "âœ… Webhook è®¾ç½®æˆåŠŸï¼"
          else
            echo "âŒ Webhook è®¾ç½®å¤±è´¥"
            exit 1
          fi
          
      # 8. éªŒè¯ Webhook çŠ¶æ€
      - name: Verify Webhook
        if: success()
        run: |
          BOT_TOKEN="${{ secrets.BOT_TOKEN }}"
          
          if [ -z "$BOT_TOKEN" ]; then
            echo "âš ï¸  BOT_TOKEN æœªè®¾ç½®ï¼Œè·³è¿‡ Webhook éªŒè¯"
            exit 0
          fi
          
          echo "éªŒè¯ Webhook çŠ¶æ€..."
          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo")
          
          echo "Webhook ä¿¡æ¯:"
          echo "$RESPONSE" | jq '.'
          
      # 9. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Deployment success
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "Worker URL: ${{ secrets.WEBHOOK_URL }}"
          echo "è¯·åœ¨ Telegram ä¸­æµ‹è¯•ä½ çš„ Bot"
          
      # 10. éƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

